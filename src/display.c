#include "display.h"
#include "I2C_master.h"
#include <util/delay.h>

// OLED used: AZDelivery 1.3 inch OLED SSH1106 128 x 64 pixel

// Each char is represented by 5 columns and 7 rows of pixels
// Each byte below represents a column of 7 vertical pixels
const uint8_t font5x7[][5] = {
    {0x00,0x00,0x00,0x00,0x00}, // 32 space 
    {0x00,0x00,0x5F,0x00,0x00}, // 33 !
    {0x00,0x07,0x00,0x07,0x00}, // 34 "
    {0x14,0x7F,0x14,0x7F,0x14}, // 35 #
    {0x24,0x2A,0x7F,0x2A,0x12}, // 36 $
    {0x23,0x13,0x08,0x64,0x62}, // 37 %
    {0x36,0x49,0x55,0x22,0x50}, // 38 &
    {0x00,0x05,0x03,0x00,0x00}, // 39 '
    {0x00,0x1C,0x22,0x41,0x00}, // 40 (
    {0x00,0x41,0x22,0x1C,0x00}, // 41 )
    {0x14,0x08,0x3E,0x08,0x14}, // 42 *
    {0x08,0x08,0x3E,0x08,0x08}, // 43 +
    {0x00,0x50,0x30,0x00,0x00}, // 44 ,
    {0x08,0x08,0x08,0x08,0x08}, // 45 -
    {0x00,0x60,0x60,0x00,0x00}, // 46 .
    {0x20,0x10,0x08,0x04,0x02}, // 47 /
    {0x3E,0x51,0x49,0x45,0x3E}, // 48 0
    {0x00,0x42,0x7F,0x40,0x00}, // 49 1
    {0x42,0x61,0x51,0x49,0x46}, // 50 2
    {0x21,0x41,0x45,0x4B,0x31}, // 51 3
    {0x18,0x14,0x12,0x7F,0x10}, // 52 4
    {0x27,0x45,0x45,0x45,0x39}, // 53 5
    {0x3C,0x4A,0x49,0x49,0x30}, // 54 6
    {0x01,0x71,0x09,0x05,0x03}, // 55 7
    {0x36,0x49,0x49,0x49,0x36}, // 56 8
    {0x06,0x49,0x49,0x29,0x1E}, // 57 9
    {0x00,0x36,0x36,0x00,0x00}, // 58 :
    {0x00,0x56,0x36,0x00,0x00}, // 59 ;
    {0x08,0x14,0x22,0x41,0x00}, // 60 <
    {0x14,0x14,0x14,0x14,0x14}, // 61 =
    {0x00,0x41,0x22,0x14,0x08}, // 62 >
    {0x02,0x01,0x51,0x09,0x06}, // 63 ?
    {0x32,0x49,0x79,0x41,0x3E}, // 64 @
    {0x7E,0x11,0x11,0x11,0x7E}, // 65 A
    {0x7F,0x49,0x49,0x49,0x36}, // 66 B
    {0x3E,0x41,0x41,0x41,0x22}, // 67 C
    {0x7F,0x41,0x41,0x22,0x1C}, // 68 D
    {0x7F,0x49,0x49,0x49,0x41}, // 69 E
    {0x7F,0x09,0x09,0x09,0x01}, // 70 F
    {0x3E,0x41,0x49,0x49,0x7A}, // 71 G
    {0x7F,0x08,0x08,0x08,0x7F}, // 72 H
    {0x00,0x41,0x7F,0x41,0x00}, // 73 I
    {0x20,0x40,0x41,0x3F,0x01}, // 74 J
    {0x7F,0x08,0x14,0x22,0x41}, // 75 K
    {0x7F,0x40,0x40,0x40,0x40}, // 76 L
    {0x7F,0x02,0x0C,0x02,0x7F}, // 77 M
    {0x7F,0x04,0x08,0x10,0x7F}, // 78 N
    {0x3E,0x41,0x41,0x41,0x3E}, // 79 O
    {0x7F,0x09,0x09,0x09,0x06}, // 80 P
    {0x3E,0x41,0x51,0x21,0x5E}, // 81 Q
    {0x7F,0x09,0x19,0x29,0x46}, // 82 R
    {0x46,0x49,0x49,0x49,0x31}, // 83 S
    {0x01,0x01,0x7F,0x01,0x01}, // 84 T
    {0x3F,0x40,0x40,0x40,0x3F}, // 85 U
    {0x1F,0x20,0x40,0x20,0x1F}, // 86 V
    {0x7F,0x20,0x18,0x20,0x7F}, // 87 W
    {0x63,0x14,0x08,0x14,0x63}, // 88 X
    {0x03,0x04,0x78,0x04,0x03}, // 89 Y
    {0x61,0x51,0x49,0x45,0x43}, // 90 Z
    {0x00,0x7F,0x41,0x41,0x00}, // 91 [
    {0x02,0x04,0x08,0x10,0x20}, // 92 '\'
    {0x00,0x41,0x41,0x7F,0x00}, // 93 ]
    {0x04,0x02,0x01,0x02,0x04}, // 94 ^
    {0x40,0x40,0x40,0x40,0x40}, // 95 _
    {0x00,0x01,0x02,0x04,0x00}, // 96 `
    {0x20,0x54,0x54,0x54,0x78}, // 97 a
    {0x7F,0x48,0x44,0x44,0x38}, // 98 b
    {0x38,0x44,0x44,0x44,0x20}, // 99 c
    {0x38,0x44,0x44,0x48,0x7F}, //100 d
    {0x38,0x54,0x54,0x54,0x18}, //101 e
    {0x08,0x7E,0x09,0x01,0x02}, //102 f
    {0x0C,0x52,0x52,0x52,0x3E}, //103 g
    {0x7F,0x08,0x04,0x04,0x78}, //104 h
    {0x00,0x44,0x7D,0x40,0x00}, //105 i
    {0x20,0x40,0x44,0x3D,0x00}, //106 j
    {0x7F,0x10,0x28,0x44,0x00}, //107 k
    {0x00,0x41,0x7F,0x40,0x00}, //108 l
    {0x7C,0x04,0x18,0x04,0x78}, //109 m
    {0x7C,0x08,0x04,0x04,0x78}, //110 n
    {0x38,0x44,0x44,0x44,0x38}, //111 o
    {0x7C,0x14,0x14,0x14,0x08}, //112 p
    {0x08,0x14,0x14,0x18,0x7C}, //113 q
    {0x7C,0x08,0x04,0x04,0x08}, //114 r
    {0x48,0x54,0x54,0x54,0x20}, //115 s
    {0x04,0x3F,0x44,0x40,0x20}, //116 t
    {0x3C,0x40,0x40,0x20,0x7C}, //117 u
    {0x1C,0x20,0x40,0x20,0x1C}, //118 v
    {0x3C,0x40,0x30,0x40,0x3C}, //119 w
    {0x44,0x28,0x10,0x28,0x44}, //120 x
    {0x0C,0x50,0x50,0x50,0x3C}, //121 y
    {0x44,0x64,0x54,0x4C,0x44}, //122 z
    {0x00,0x08,0x36,0x41,0x00}, //123 {
    {0x00,0x00,0x7F,0x00,0x00}, //124 |
    {0x00,0x41,0x36,0x08,0x00}, //125 }
    {0x10,0x08,0x08,0x10,0x08}, //126 ~
    {0x00,0x06,0x09,0x09,0x06}, //127 (DEL - smiley fallback)
  };
  

void oled_command(uint8_t cmd) {
    i2c_start();
    i2c_write(0x3C << 1);  // Slave Address + Write
    i2c_write(0x00);       // Control Byte (Command Mode)
    i2c_write(cmd);
    i2c_stop();
}

void oled_send_data(uint8_t data) {
    i2c_start();
    i2c_write(0x3C << 1);  // Slave Address + Write
    i2c_write(0x40);       // Control Byte (Data Mode)
    i2c_write(data);
    i2c_stop();
}

void oled_init() {
    oled_command(0xAE); // Display OFF
    oled_command(0xD5); // Set Display Clock Divide Ratio/Oscillator Frequency
    oled_command(0x80);
    oled_command(0xA8); // Set Multiplex Ratio (default 0x3F for 128x64)
    oled_command(0x3F);
    oled_command(0xD3); // Set Display Offset
    oled_command(0x00);
    oled_command(0x40); // Set Display Start Line
    oled_command(0xAD); // Charge Pump Setting
    oled_command(0x8B); // Enable charge pump regulator
    oled_command(0xA1); // Segment Re-map (A0/A1)
    oled_command(0xC8); // Set COM Output Scan Direction
    oled_command(0xDA); // Set COM Pins Hardware Configuration
    oled_command(0x12);
    oled_command(0x81); // Set Contrast Control
    oled_command(0x80);
    oled_command(0xD9); // Set Pre-charge Period
    oled_command(0x22);
    oled_command(0xDB); // Set VCOMH Deselect Level
    oled_command(0x30);
    oled_command(0xA4); // Entire Display ON (A4: Resume to RAM content display)
    oled_command(0xA6); // Set Normal Display Mode
    oled_command(0xAF); // Display ON
}

// OLED (128x64) is devided in 8 pages, each 128 pixels wide and 8 tall
// This simplifies addressing, first select page and then column inside page
// 0xB0 command selects start of pages, adding page moves through all pages
// 0x02 and 0x10 are the base values, adding selects a specific column
void oled_set_cursor(uint8_t x, uint8_t page) {
    oled_command(0xB0 + page);             // Set page
    oled_command(0x02 + (x & 0x0F));       // Lower byte of column address
    oled_command(0x10 + ((x >> 4) & 0x0F));// Upper byte of column address
}

void oled_write_char(char c) {
    if (c < 32 || c > 127) c = '?';         // First 32 ASCIIs are not-printable
    for (uint8_t i = 0; i < 5; i++) {       // 5 columns per char
        oled_send_data(font5x7[c - 32][i]); // Get the byte that represents column
    }
    oled_send_data(0x00);  // spacing
}

void oled_write_string(const char* str) {
    while (*str) {
        oled_write_char(*str++);   // print char and move to next
    }
}

void oled_fill(uint8_t color) {
    for (uint8_t page = 0; page < 8; page++) {
        oled_command(0xB0 + page); // Set page address
        oled_command(0x02);        // Lower byte of column address
        oled_command(0x10);        // Upper byte of column address
        for (uint8_t i = 0; i < 128; i++) {
            oled_send_data(color);
        }
    }
}

/*
int main() {
    i2c_init();
    oled_init();
    oled_fill(0x00);    // Clear screen
    oled_set_cursor(0, 0);
    oled_write_string("Hello!");
    oled_set_cursor(0, 1);
    oled_write_string("Hello!");
    while (1) {
        
    }
}
*/